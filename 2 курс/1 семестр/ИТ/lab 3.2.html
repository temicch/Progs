
<HTML>
<HEAD>
<TITLE>Лабораторная работа 3.2</TITLE>
</HEAD>


<script language="JavaScript">

function setCookie(name, value, expire) 
{  
	document.cookie = name + "=" + escape(value) +
		//В строку дописывается имя устанавливаемой cookie
	((expire == null) ? "" : ("; expires=" + expire.toGMTString()))
		//Устанавливается время действия
}

function getCookie(Name) 
{   
	var search = Name + "="
		//Создается строка для поиска в document.cookie
	if (document.cookie.length > 0) 
	{
		offset = document.cookie.indexOf(search)
			//Поиск cookie по ее имени
		if (offset != -1) 
		{
			offset += search.length
			end = document.cookie.indexOf(";", offset)
				//Определили положение нужной cookie, и по индексам вырежем ее
			if (end == -1)
				end = document.cookie.length
			return unescape(document.cookie.substring(offset, end))
				//Вернули подстроку, содержащюю нужное значение cookie
		}
	}
	//return 0;
}

function buttonExit(name) 
{
	now = new Date();
	now.setTime(now.getTime() - 1000*60*60*24*365);
	setCookie(name, "", now);
	registrate();
}

function buttonClear()
{
	setCookie('visits', 0);
	login();
}

function buttonReg()
{
	if(document.getElementById('textInput').value == "")
	{
		document.getElementById('textInput').value = "Неверно введены данные";
		return;
	}
	var today = new Date();
	expire = new Date();
	expire.setTime(today.getTime() + 1000*60*60*24*365);
	
	setCookie('name', document.getElementById('textInput').value, expire);
	setCookie('visits', 0, expire);
	
	d2 = new Date();
	setCookie('lastEnter', d2.getTime(), expire);
	document.getElementById('text').innerHTML = "";
	getCookie('name');
	login();
}

function login()
{
	d = new Date();
	
	d2 = new Date();
	d2.setTime(getCookie('lastEnter'));
	
	then = new Date(d2);
		
    secondsLeft = Math.round((60 - then.getSeconds() + d.getSeconds())%60);
	minutesLeft = Math.round((60 - then.getMinutes() + d.getMinutes())%60);
	hoursLeft = Math.round((24 - then.getHours() + d.getHours())%24);
	msPerDay = 24 * 60 * 60 * 1000 ; // Number of milliseconds per day
	daysLeft = Math.round((then.getTime() - d.getTime()) / msPerDay);	
	monthsLeft = (12 - then.getMonth() + d.getMonth()) % 12;
	// Небольшая поправочка для месяцев, оч нужная
	if((d.getFullYear() - then.getFullYear() > 1) || 
		d.getMonth() >= then.getMonth() && d.getFullYear() != then.getFullYear()) 
			monthsLeft += 12 * (d.getFullYear() - then.getFullYear());
	if(d.getFullYear() - then.getFullYear() > 1 && d.getMonth() >= then.getMonth()) 
	 	monthsLeft -=12;
	
	var today = new Date();
	expire = new Date();
	expire.setTime(today.getTime() + 1000*60*60*24*365);	
	
	setCookie('visits', Number(getCookie('visits')) + 1, expire);
	setCookie('lastEnter', d.getTime(), expire);
	document.getElementById('but').type = 'HIDDEN';
	document.getElementById('clear').type = 'button';
	document.getElementById('exit').type = 'button';
	
	document.getElementById('text').innerHTML = "<b>COOKIE</b><br><br>Доброй ночи, " + 
	getCookie('name') + "!<br>Вы были на этой странице: " + 
	getCookie('visits') + " раз" +
	"<br>Последний раз вы заходили: " +
	((monthsLeft) ? monthsLeft + " месяцев " : "") +
	((daysLeft) ? daysLeft + " дней " : "") +
	((hoursLeft) ? hoursLeft + " часов " : "") +
	((minutesLeft) ? minutesLeft + " минут " : "") +
	secondsLeft + " секунд " + " назад";
}

function registrate()
{
	document.getElementById('but').type = "button";
	document.getElementById('clear').type = "HIDDEN";
	document.getElementById('exit').type = "HIDDEN";
	document.getElementById('text').innerHTML = "<b>COOKIE</b><br><br>Доброй ночи! <br>Представьтесь, пожалуйста <br><input id = 'textInput' type = 'text'><br>";
}
</script>

<BODY onLoad = "getCookie('name') ? login() : registrate()">

<p id="text">
</p>
<br>
<input  id = "but" type="button" onClick = "buttonReg()" value = "Изменить имя">
<input  id = "clear" type="button" onClick = "buttonClear()" value = "Обнулить посещения">
<input  id = "exit" type="button" onClick = "buttonExit('name')" value = "Выйти">
</BODY></HTML>